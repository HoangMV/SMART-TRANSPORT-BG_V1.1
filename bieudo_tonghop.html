<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω Th√¥ng tin Tuy·∫øn V·∫≠n t·∫£i - B·ªô Giao th√¥ng V·∫≠n t·∫£i</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1e3c72',
                        'primary-light': '#2a5298',
                        'secondary': '#4a90e2',
                        'secondary-light': '#357abd',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-primary {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .gradient-secondary {
            background: linear-gradient(135deg, #4a90e2, #357abd);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #ffffff, #f8fbff);
        }

        .gradient-light {
            background: linear-gradient(135deg, #f8fbff, #e8f4fd);
        }

        .gradient-table {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
        }

        .gradient-blue {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #f3f3f3;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            transition: width 0.3s ease;
        }

        .route-row {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .route-row:hover {
            background-color: #f0f9ff;
            transform: translateY(-1px);
        }

        .filter-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .filter-panel.open {
            max-height: 500px;
        }
    </style>
</head>

<body class="font-sans min-h-screen leading-relaxed px-8 bg-gray-50">
    <div id="loadingMessage" class="text-center py-20">
        <div class="loading mb-4"></div>
        <p class="mb-4">ƒêang t·∫£i d·ªØ li·ªáu...</p>
        <div class="progress-bar mx-auto max-w-md mb-2">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div id="loadingText" class="text-sm text-gray-600">Kh·ªüi t·∫°o...</div>
    </div>

    <!-- Danh s√°ch tuy·∫øn -->
    <div id="routeListContent"
        class="max-w-8xl mx-auto bg-white rounded-2xl overflow-hidden shadow-2xl border-2 border-blue-100"
        style="display: none;">
        <!-- Header ch√≠nh th·ª©c -->
        <div class="text-white pt-6 pb-3 px-8 text-center relative flex items-center justify-center"
            style="background: url(https://hoangmv.github.io/SMART-TRANSPORT-BG_V1.1/bg_header-qlvt.png) center center / cover no-repeat;">
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>
            <div class="relative z-10">
                <div class="flex items-center justify-center gap-5 mb-4">
                    <div
                        class="w-15 h-15 bg-white rounded-full flex items-center justify-center text-3xl text-primary font-bold shadow-lg">
                        üöå
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-shadow-lg">H·ªÜ TH·ªêNG QU·∫¢N L√ù TH√îNG TIN TUY·∫æN V·∫¨N T·∫¢I</h1>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation header v·ªõi tabs -->
        <div class="bg-blue-600 text-white">
            <div class="flex">
                <div class="bg-blue-500 px-6 py-3 font-semibold border-r border-blue-400 flex items-center gap-2">
                    üìã TUY·∫æN C√îNG B·ªê
                </div>
            </div>
        </div>

        <!-- Search bar -->
        <div class="bg-gray-100 p-4 border-b">
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm theo t√™n/m√£ tuy·∫øn..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="performSearch()" 
                        class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    üîç T√¨m ki·∫øm
                </button>
                <button onclick="toggleAdvancedSearch()" 
                        class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                    üîß T√¨m ki·∫øm n√¢ng cao
                </button>
            </div>
        </div>

        <!-- Advanced search panel -->
        <div id="advancedSearchPanel" class="filter-panel bg-blue-50 border-b">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üîç B·ªô l·ªçc t√¨m ki·∫øm n√¢ng cao</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">N∆°i ƒëi</label>
                        <select id="filterNoiDi" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">N∆°i ƒë·∫øn</label>
                        <select id="filterNoiDen" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ph√¢n lo·∫°i tuy·∫øn</label>
                        <select id="filterPhanLoai" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">C·ª± ly tuy·∫øn (km)</label>
                        <div class="flex gap-2">
                            <input type="number" id="filterCuLyMin" placeholder="T·ª´" 
                                   class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="number" id="filterCuLyMax" placeholder="ƒê·∫øn" 
                                   class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex gap-3">
                    <button onclick="applyAdvancedFilter()" 
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        √Åp d·ª•ng l·ªçc
                    </button>
                    <button onclick="clearAdvancedFilter()" 
                            class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        X√≥a b·ªô l·ªçc
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter tabs -->
        <div class="bg-white p-4 border-b flex flex-wrap gap-2 text-sm">
            <span class="text-gray-600">L·ªçc theo:</span>
            <div class="flex flex-wrap gap-2">
                <button onclick="filterByColumn('NoiDi')" class="filter-tab bg-gray-100 hover:bg-blue-100 px-3 py-1 rounded-lg transition-colors">
                    N∆°i ƒëi
                </button>
                <button onclick="filterByColumn('NoiDen')" class="filter-tab bg-gray-100 hover:bg-blue-100 px-3 py-1 rounded-lg transition-colors">
                    N∆°i ƒë·∫øn
                </button>
                <button onclick="filterByColumn('HanhTrinh')" class="filter-tab bg-gray-100 hover:bg-blue-100 px-3 py-1 rounded-lg transition-colors">
                    H√†nh tr√¨nh ch·∫°y xe
                </button>
                <button onclick="filterByColumn('CuLy')" class="filter-tab bg-gray-100 hover:bg-blue-100 px-3 py-1 rounded-lg transition-colors">
                    C·ª± ly tuy·∫øn
                </button>
                <button onclick="filterByColumn('LuuLuong')" class="filter-tab bg-gray-100 hover:bg-blue-100 px-3 py-1 rounded-lg transition-colors">
                    L∆∞u l∆∞·ª£ng cho ph√©p
                </button>
            </div>
        </div>

        <!-- Results count -->
        <div class="bg-gray-50 px-6 py-3 border-b">
            <span class="text-sm text-gray-600">
                Hi·ªÉn th·ªã <span id="routeCount" class="font-semibold text-blue-600">0</span> tuy·∫øn
            </span>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-200 text-gray-700">
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[50px]">STT</th>
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[120px]">M√£ tuy·∫øn</th>
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[150px]">
                            T·ªânh n∆°i ƒëi/<br>ƒë·∫øn (v√†<br>ng∆∞·ª£c l·∫°i)
                        </th>
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[150px]">
                            T·ªânh n∆°i ƒëi/<br>ƒë·∫øn (v√†<br>ng∆∞·ª£c l·∫°i)
                        </th>
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[150px]">
                            BX n∆°i ƒëi/<br>ƒë·∫øn (v√†<br>ng∆∞·ª£c l·∫°i)
                        </th>
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[150px]">
                            BX n∆°i ƒëi/<br>ƒë·∫øn (v√†<br>ng∆∞·ª£c l·∫°i)
                        </th>
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[300px]">H√†nh tr√¨nh ch·∫°y xe</th>
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[80px]">
                            C·ª±<br>ly<br>tuy·∫øn<br>(km)
                        </th>
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[80px]">
                            L∆∞u<br>l∆∞·ª£ng<br>cho<br>ph√©p<br>(chuy·∫øn/<br>th√°ng)
                        </th>
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[80px]">
                            T·ªïng<br>s·ªë<br>chuy·∫øn<br>ƒëang<br>khai<br>th√°c
                        </th>
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[80px]">
                            L∆∞u<br>l∆∞·ª£ng<br>c√≤n<br>l·∫°i
                        </th>
                        <th class="px-4 py-3 text-center font-semibold border-r border-gray-300 min-w-[80px]">
                            Th·ªùi<br>gian<br>gi√£n<br>c√°ch<br>t·ªëi<br>thi·ªÅu<br>(ph√∫t/<br>chuy·∫øn)
                        </th>
                        <th class="px-4 py-3 text-center font-semibold min-w-[60px]">Chi ti·∫øt</th>
                    </tr>
                </thead>
                <tbody id="routeTableBody">
                    <!-- D·ªØ li·ªáu tuy·∫øn s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn v√†o ƒë√¢y -->
                </tbody>
            </table>
        </div>

        <!-- Footer th√¥ng tin -->
        <div class="gradient-primary text-white py-5 text-center">
            <p class="mt-1 mb-0 text-xs opacity-70">
                C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="current-time-list"></span>
            </p>
        </div>
    </div>

    <!-- Chi ti·∫øt tuy·∫øn -->
    <div id="routeDetailContent"
        class="max-w-8xl mx-auto bg-white rounded-2xl overflow-hidden shadow-2xl border-2 border-blue-100"
        style="display: none;">
        <!-- Header ch√≠nh th·ª©c -->
        <div class="text-white pt-6 pb-3 px-8 text-center relative flex items-center justify-center"
            style="background: url(https://hoangmv.github.io/SMART-TRANSPORT-BG_V1.1/bg_header-qlvt.png) center center / cover no-repeat;">
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>
            <div class="relative z-10">
                <div class="flex items-center justify-center gap-5 mb-4">
                    <div
                        class="w-15 h-15 bg-white rounded-full flex items-center justify-center text-3xl text-primary font-bold shadow-lg">
                        üöå
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-shadow-lg">H·ªÜ TH·ªêNG QU·∫¢N L√ù TH√îNG TIN TUY·∫æN V·∫¨N T·∫¢I</h1>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation header -->
        <div
            class="gradient-secondary text-white py-2 px-6 flex justify-between items-center border-b-4 border-blue-700">
            <h2 class="text-lg font-semibold flex items-center gap-3">
                <span class="text-xl">üìä</span>
                TH√îNG TIN TUY·∫æN
            </h2>
            <button onclick="backToList()" 
                    class="bg-white text-secondary px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-colors flex items-center gap-2">
                ‚Üê Quay l·∫°i danh s√°ch
            </button>
        </div>

        <!-- Th√¥ng tin chi ti·∫øt tuy·∫øn -->
        <div class="border-b-4 border-gray-100">
            <div class="gradient-light py-3 px-6 border-b-2 border-blue-200 flex items-center gap-4">
                <div class="text-secondary bg-white rounded-full shadow-md">üìã</div>
                <span class="font-bold text-gray-700 text-base uppercase tracking-wide">Th√¥ng tin chi ti·∫øt tuy·∫øn</span>
            </div>

            <div class="gradient-bg px-20 py-4" id="tuyenInfo">
                <!-- Th√¥ng tin tuy·∫øn s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn v√†o ƒë√¢y -->
            </div>
        </div>

        <!-- Th√¥ng tin th√¥ng b√°o ƒë∆°n v·ªã ƒëƒÉng k√Ω khai th√°c th√†nh c√¥ng -->
        <div class="border-b-4 border-gray-100">
            <div class="gradient-light py-3 px-6 border-b-2 border-blue-200 flex items-center gap-4">
                <div class="text-secondary bg-white rounded-full shadow-md">üìã</div>
                <span class="font-bold text-gray-700 text-base uppercase tracking-wide">Th√¥ng tin th√¥ng b√°o ƒë∆°n v·ªã ƒëƒÉng
                    k√Ω khai th√°c th√†nh c√¥ng</span>
            </div>

            <div class="gradient-bg p-4">
                <table class="w-full border-collapse border-2 border-gray-200 rounded-lg overflow-hidden shadow-lg">
                    <thead>
                        <tr>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                STT</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                S·ªë th√¥ng b√°o</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                Ng√†y vƒÉn b·∫£n th√¥ng b√°o</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                Ng√†y b·∫Øt ƒë·∫ßu khai th√°c</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                ƒê∆°n v·ªã kinh doanh v·∫≠n t·∫£i</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                C∆° quan c·∫•p</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="thongBaoTable">
                        <!-- D·ªØ li·ªáu th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn v√†o ƒë√¢y -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì xe ch·∫°y -->
        <div class="border-b-4 border-gray-100">
            <div class="gradient-light py-3 px-6 border-b-2 border-blue-200 flex items-center gap-4">
                <div class="text-secondary bg-white rounded-full shadow-md">üìã</div>
                <span class="font-bold text-gray-700 text-base uppercase tracking-wide">
                    Bi·ªÉu ƒë·ªì xe ch·∫°y
                    <span class="text-red-600 font-semibold">( Ch·ªâ c·∫≠p nh·∫≠t c√°c gi·ªù ƒëang c√≥ ƒë∆°n v·ªã KDVT khai th√°c
                        )</span>
                </span>
            </div>

            <!-- Legend -->
            <div class="flex gap-8 p-3 gradient-light text-xs justify-end flex-wrap border-b-2 border-gray-200">
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-gray-100 border-gray-200 shadow-sm"></div>
                    <span>Ch∆∞a ƒëƒÉng k√Ω</span>
                </div>
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-lime-300 border-white shadow-sm"></div>
                    <span>ƒêang khai th√°c</span>
                </div>
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-amber-300 border-white shadow-sm"></div>
                    <span>C√≤n l∆∞u l∆∞·ª£ng</span>
                </div>
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-amber-100 border-white shadow-sm"></div>
                    <span>H·∫øt l∆∞u l∆∞·ª£ng</span>
                </div>
            </div>

            <!-- L·ªãch xe ch·∫°y -->
            <div class="gradient-primary text-white text-center py-5 font-bold text-base uppercase tracking-wider">
                Gi·ªù xu·∫•t b·∫øn
            </div>

            <div id="bieuDoXeChay">
                <!-- Bi·ªÉu ƒë·ªì xe ch·∫°y s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
            </div>
        </div>

        <!-- Footer th√¥ng tin -->
        <div class="gradient-primary text-white py-5 text-center">
            <p class="mt-1 mb-0 text-xs opacity-70">
                C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="current-time"></span>
            </p>
        </div>
    </div>

    <script>
        // Constants for AppSheet connection
        const appId = 'd22767b5-f711-42f8-bbbd-4cf04b26ef3d';
        const accessKey = 'V2-Qcjpo-7Ybu9-g87XI-TFLes-kJGWn-btYR5-cLMmk-FjrRj';
        const region = 'www';

        // Global data storage
        let allTuyenData = [];
        let allThongBaoData = [];
        let allChiTietData = [];
        let filteredTuyenData = [];

        // Progress tracking
        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('loadingText').textContent = text;
        }

        // Function to fetch data from AppSheet
        async function fetchDataFromAppSheet(tableName) {
            try {
                const body = {
                    Action: 'Find',
                    Properties: {},
                    Selector: `Filter(${tableName}, true)`
                };

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error(`Failed to fetch data from ${tableName}:`, error);
                return [];
            }
        }

        // Load all data in parallel
        async function loadAllDataParallel() {
            updateProgress(10, 'ƒêang t·∫£i t·∫•t c·∫£ d·ªØ li·ªáu...');

            const [tuyenData, thongBaoData, chiTietData] = await Promise.all([
                fetchDataFromAppSheet('DANHMUCTUYENCODINH'),
                fetchDataFromAppSheet('THONGBAO_KHAITHAC'),
                fetchDataFromAppSheet('BieuDoChayXeChiTiet')
            ]);

            updateProgress(60, 'ƒê√£ t·∫£i xong d·ªØ li·ªáu, ƒëang x·ª≠ l√Ω...');

            return {
                tuyenData,
                thongBaoData,
                chiTietData
            };
        }

        // Format date function
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        // Calculate active notifications for a route
        function getActiveNotificationsCount(maSoTuyen) {
            return allThongBaoData.filter(tb => 
                tb.Ref_Tuyen === maSoTuyen && 
                (!tb.TrangThai || tb.TrangThai !== 'H·∫øt hi·ªáu l·ª±c')
            ).length;
        }

        // Calculate remaining capacity
        function getRemainingCapacity(tuyen) {
            const tongChuyen = parseInt(tuyen.TongChuyenThang) || 0;
            const chuyenDaKhaiThac = parseInt(tuyen.ChuyenDaKhaiThac) || 0;
            return Math.max(0, tongChuyen - chuyenDaKhaiThac);
        }

        // Display route list as table
        function displayRouteList(tuyenList) {
            const tableBody = document.getElementById('routeTableBody');
            const routeCount = document.getElementById('routeCount');
            
            routeCount.textContent = tuyenList.length;

            if (!tuyenList || tuyenList.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="13" class="text-center py-8 text-gray-500 italic">
                            Kh√¥ng t√¨m th·∫•y tuy·∫øn n√†o ph√π h·ª£p v·ªõi ti√™u ch√≠ t√¨m ki·∫øm
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            tuyenList.forEach((tuyen, index) => {
                const activeNotifications = getActiveNotificationsCount(tuyen.MaSoTuyen);
                const remainingCapacity = getRemainingCapacity(tuyen);

                html += `
                    <tr class="route-row border-b border-gray-200 hover:bg-blue-50" onclick="showRouteDetail('${tuyen.MaSoTuyen}')">
                        <td class="px-4 py-3 text-center border-r border-gray-200">${index + 1}</td>
                        <td class="px-4 py-3 text-center border-r border-gray-200 font-medium text-blue-600">${tuyen.MaSoTuyen || ''}</td>
                        <td class="px-4 py-3 border-r border-gray-200">${tuyen.TinhDi || ''}</td>
                        <td class="px-4 py-3 border-r border-gray-200">${tuyen.TinhDen || ''}</td>
                        <td class="px-4 py-3 border-r border-gray-200">${tuyen.BenDi || ''}</td>
                        <td class="px-4 py-3 border-r border-gray-200">${tuyen.BenDen || ''}</td>
                        <td class="px-4 py-3 border-r border-gray-200 text-justify text-xs">${tuyen.HanhTrinh || ''}</td>
                        <td class="px-4 py-3 text-center border-r border-gray-200">${tuyen.CuLyTuyen_km || ''}</td>
                        <td class="px-4 py-3 text-center border-r border-gray-200">${tuyen.TongChuyenThang || ''}</td>
                        <td class="px-4 py-3 text-center border-r border-gray-200">${tuyen.ChuyenDaKhaiThac || '0'}</td>
                        <td class="px-4 py-3 text-center border-r border-gray-200 ${remainingCapacity > 0 ? 'text-green-600' : 'text-red-600'}">${remainingCapacity}</td>
                        <td class="px-4 py-3 text-center border-r border-gray-200">${tuyen.GianCachToiThieu_phut || ''}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="event.stopPropagation(); showRouteDetail('${tuyen.MaSoTuyen}')" 
                                    class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition-colors">
                                üöå Chi ti·∫øt
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        // Setup filter options
        function setupFilterOptions() {
            const noiDiSet = new Set();
            const noiDenSet = new Set();
            const phanLoaiSet = new Set();

            allTuyenData.forEach(tuyen => {
                if (tuyen.TinhDi) noiDiSet.add(tuyen.TinhDi);
                if (tuyen.TinhDen) noiDenSet.add(tuyen.TinhDen);
                if (tuyen.PhanLoaiTuyen) phanLoaiSet.add(tuyen.PhanLoaiTuyen);
            });

            // Populate filter dropdowns
            const filterNoiDi = document.getElementById('filterNoiDi');
            const filterNoiDen = document.getElementById('filterNoiDen');
            const filterPhanLoai = document.getElementById('filterPhanLoai');

            // Clear existing options (except "T·∫•t c·∫£")
            filterNoiDi.innerHTML = '<option value="">T·∫•t c·∫£</option>';
            filterNoiDen.innerHTML = '<option value="">T·∫•t c·∫£</option>';
            filterPhanLoai.innerHTML = '<option value="">T·∫•t c·∫£</option>';

            // Add options
            Array.from(noiDiSet).sort().forEach(item => {
                filterNoiDi.innerHTML += `<option value="${item}">${item}</option>`;
            });

            Array.from(noiDenSet).sort().forEach(item => {
                filterNoiDen.innerHTML += `<option value="${item}">${item}</option>`;
            });

            Array.from(phanLoaiSet).sort().forEach(item => {
                filterPhanLoai.innerHTML += `<option value="${item}">${item}</option>`;
            });
        }

        // Toggle advanced search panel
        function toggleAdvancedSearch() {
            const panel = document.getElementById('advancedSearchPanel');
            panel.classList.toggle('open');
        }

        // Perform basic search
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredTuyenData = allTuyenData;
            } else {
                filteredTuyenData = allTuyenData.filter(tuyen => 
                    (tuyen.MaSoTuyen && tuyen.MaSoTuyen.toLowerCase().includes(searchTerm)) ||
                    (tuyen.TenTuyen && tuyen.TenTuyen.toLowerCase().includes(searchTerm)) ||
                    (tuyen.TinhDi && tuyen.TinhDi.toLowerCase().includes(searchTerm)) ||
                    (tuyen.TinhDen && tuyen.TinhDen.toLowerCase().includes(searchTerm)) ||
                    (tuyen.BenDi && tuyen.BenDi.toLowerCase().includes(searchTerm)) ||
                    (tuyen.BenDen && tuyen.BenDen.toLowerCase().includes(searchTerm)) ||
                    (tuyen.HanhTrinh && tuyen.HanhTrinh.toLowerCase().includes(searchTerm))
                );
            }
            
            displayRouteList(filteredTuyenData);
        }

        // Apply advanced filter
        function applyAdvancedFilter() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const noiDi = document.getElementById('filterNoiDi').value;
            const noiDen = document.getElementById('filterNoiDen').value;
            const phanLoai = document.getElementById('filterPhanLoai').value;
            const cuLyMin = document.getElementById('filterCuLyMin').value;
            const cuLyMax = document.getElementById('filterCuLyMax').value;

            filteredTuyenData = allTuyenData.filter(tuyen => {
                // Basic search filter
                const matchesSearch = !searchTerm || 
                    (tuyen.MaSoTuyen && tuyen.MaSoTuyen.toLowerCase().includes(searchTerm)) ||
                    (tuyen.TenTuyen && tuyen.TenTuyen.toLowerCase().includes(searchTerm)) ||
                    (tuyen.TinhDi && tuyen.TinhDi.toLowerCase().includes(searchTerm)) ||
                    (tuyen.TinhDen && tuyen.TinhDen.toLowerCase().includes(searchTerm)) ||
                    (tuyen.BenDi && tuyen.BenDi.toLowerCase().includes(searchTerm)) ||
                    (tuyen.BenDen && tuyen.BenDen.toLowerCase().includes(searchTerm)) ||
                    (tuyen.HanhTrinh && tuyen.HanhTrinh.toLowerCase().includes(searchTerm));

                // Advanced filters
                const matchesNoiDi = !noiDi || tuyen.TinhDi === noiDi;
                const matchesNoiDen = !noiDen || tuyen.TinhDen === noiDen;
                const matchesPhanLoai = !phanLoai || tuyen.PhanLoaiTuyen === phanLoai;

                // Distance filter
                const cuLy = parseFloat(tuyen.CuLyTuyen_km) || 0;
                const matchesCuLyMin = !cuLyMin || cuLy >= parseFloat(cuLyMin);
                const matchesCuLyMax = !cuLyMax || cuLy <= parseFloat(cuLyMax);

                return matchesSearch && matchesNoiDi && matchesNoiDen && matchesPhanLoai && matchesCuLyMin && matchesCuLyMax;
            });

            displayRouteList(filteredTuyenData);
            
            // Show applied filters
            showAppliedFilters();
        }

        // Clear advanced filter
        function clearAdvancedFilter() {
            document.getElementById('filterNoiDi').value = '';
            document.getElementById('filterNoiDen').value = '';
            document.getElementById('filterPhanLoai').value = '';
            document.getElementById('filterCuLyMin').value = '';
            document.getElementById('filterCuLyMax').value = '';
            
            // Apply search with cleared filters
            performSearch();
        }

        // Show applied filters (optional visual feedback)
        function showAppliedFilters() {
            const filters = [];
            const noiDi = document.getElementById('filterNoiDi').value;
            const noiDen = document.getElementById('filterNoiDen').value;
            const phanLoai = document.getElementById('filterPhanLoai').value;
            const cuLyMin = document.getElementById('filterCuLyMin').value;
            const cuLyMax = document.getElementById('filterCuLyMax').value;

            if (noiDi) filters.push(`N∆°i ƒëi: ${noiDi}`);
            if (noiDen) filters.push(`N∆°i ƒë·∫øn: ${noiDen}`);
            if (phanLoai) filters.push(`Ph√¢n lo·∫°i: ${phanLoai}`);
            if (cuLyMin || cuLyMax) {
                const range = `${cuLyMin || '0'}-${cuLyMax || '‚àû'} km`;
                filters.push(`C·ª± ly: ${range}`);
            }

            if (filters.length > 0) {
                console.log('ƒê√£ √°p d·ª•ng b·ªô l·ªçc:', filters.join(', '));
            }
        }

        // Filter by column (for quick filter tabs)
        function filterByColumn(column) {
            // This function can be expanded to show quick filter options
            console.log('Filter by column:', column);
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            
            // Search on Enter key
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Real-time search (optional)
            // searchInput.addEventListener('input', performSearch);
        }

        // Show route detail
        function showRouteDetail(maSoTuyen) {
            const selectedTuyen = allTuyenData.find(t => t.MaSoTuyen === maSoTuyen);
            if (!selectedTuyen) {
                alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin tuy·∫øn');
                return;
            }

            // Filter data for selected route
            const filteredThongBao = allThongBaoData.filter(tb => tb.Ref_Tuyen === maSoTuyen);
            const thongBaoIds = filteredThongBao.map(tb => tb.SoThongBao);
            const filteredChiTiet = allChiTietData.filter(ct =>
                ct.SoThongBao && thongBaoIds.includes(ct.SoThongBao)
            );

            // Display data
            displayTuyenInfo(selectedTuyen);
            displayThongBaoTable(filteredThongBao);
            generateScheduleTable(filteredThongBao, filteredChiTiet);

            // Update current time
            document.getElementById('current-time').textContent = new Date().toLocaleString('vi-VN');

            // Switch to detail view
            document.getElementById('routeListContent').style.display = 'none';
            document.getElementById('routeDetailContent').style.display = 'block';
        }

        // Back to list
        function backToList() {
            document.getElementById('routeDetailContent').style.display = 'none';
            document.getElementById('routeListContent').style.display = 'block';
        }

        // Display route information (unchanged from previous version)
        function displayTuyenInfo(tuyenData) {
            const tuyenInfoDiv = document.getElementById('tuyenInfo');

            const infoHTML = `
                <div class="space-y-0">
                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            M√£ s·ªë tuy·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.MaSoTuyen || ''}</div>
                    </div>
                    
                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T√™n tuy·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TenTuyen || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T·ªânh n∆°i ƒëi:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TinhDi || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T·ªânh n∆°i ƒë·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TinhDen || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            BX ƒëi:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.BenDi || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            BX ƒë·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.BenDen || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex relative">
                            H√†nh tr√¨nh ch·∫°y xe:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex font-medium text-justify">
                            ${tuyenData.HanhTrinh || ''}
                        </div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            Ph√¢n lo·∫°i tuy·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.PhanLoaiTuyen || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T√¨nh tr·∫°ng khai th√°c tuy·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TinhTrangKhaiThac || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            C·ª± ly Tuy·∫øn (km):
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.CuLyTuyen_km || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T·ªïng s·ªë chuy·∫øn xe ƒë∆∞·ª£c khai th√°c (chuy·∫øn/ th√°ng):
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TongChuyenThang || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T·ªïng s·ªë chuy·∫øn xe ƒë√£ c√≥ ƒë∆°n v·ªã tham gia khai th√°c (chuy·∫øn/ th√°ng):
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.ChuyenDaKhaiThac || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            Th·ªùi gian gi√£n c√°ch t·ªëi thi·ªÉu gi·ªØa c√°c chuy·∫øn xe li√™n k·∫ø (ph√∫t/ chuy·∫øn):
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.GianCachToiThieu_phut || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            Quy·∫øt ƒë·ªãnh ban h√†nh:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.SoQuyetDinh || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            Ng√†y ban h√†nh:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.NgayBanHanh || ''}</div>
                    </div>

                    <div class="grid grid-cols-6">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            ƒê∆°n v·ªã ban h√†nh:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.DonViBanHanh || ''}</div>
                    </div>
                </div>
            `;

            tuyenInfoDiv.innerHTML = infoHTML;
        }

        // Display notification table (unchanged)
        function displayThongBaoTable(thongBaoList) {
            const tableBody = document.getElementById('thongBaoTable');

            const activeThongBao = thongBaoList.filter(thongBao =>
                !thongBao.TrangThai || thongBao.TrangThai !== 'H·∫øt hi·ªáu l·ª±c'
            );

            if (!activeThongBao || activeThongBao.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500 italic border border-gray-200">
                            Ch∆∞a c√≥ th√¥ng b√°o ƒëang c√≥ hi·ªáu l·ª±c
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            activeThongBao.forEach((thongBao, index) => {
                const fileData = thongBao.File && thongBao.File.trim() !== '' ? thongBao.File.trim() : null;
                const hasFile = fileData && fileData !== '';

                html += `
                    <tr class="even:bg-blue-50">
                        <td class="py-3 px-3 text-center border border-gray-200 text-xs">${index + 1}.</td>
                        <td class="py-3 px-3 text-center border border-gray-200 text-xs">${thongBao.SoThongBao || ''}</td>
                        <td class="py-3 px-3 text-center border border-gray-200 text-xs">${formatDate(thongBao.NgayBanHanh) || ''}</td>
                        <td class="py-3 px-3 text-center border border-gray-200 text-xs">${thongBao.NgayBatDau || ''}</td>
                        <td class="py-3 px-3 border border-gray-200 text-xs">${thongBao['ƒê∆°n v·ªã kinh doanh v·∫≠n t·∫£i'] || ''}</td>
                        <td class="py-3 px-3 border border-gray-200 text-xs">${thongBao.CQBanHanh || ''}</td>
                        <td class="py-4 px-3 text-center border border-gray-200">
                            <div class="flex justify-center gap-2">
                                ${hasFile ? `
                                    <div class="w-8 h-8 gradient-blue text-white flex items-center justify-center rounded-lg cursor-pointer text-sm hover:opacity-80 transition-opacity" 
                                         title="M·ªü file ƒë√≠nh k√®m" 
                                         onclick="openAppSheetFile('${fileData.replace(/'/g, "\\'")}')">
                                        üìÑ
                                    </div>
                                ` : `
                                    <div class="w-8 h-8 bg-gray-300 text-gray-500 flex items-center justify-center rounded-lg text-sm" 
                                         title="Kh√¥ng c√≥ file ƒë√≠nh k√®m">
                                        üìÑ
                                    </div>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        // Open AppSheet file (unchanged)
        function openAppSheetFile(fileData) {
            if (!fileData || fileData.trim() === '') {
                alert('Kh√¥ng c√≥ file ƒë√≠nh k√®m');
                return;
            }

            try {
                console.log('File data received:', fileData);

                if (fileData.startsWith('https://www.appsheet.com/template/gettablefileurl') ||
                    fileData.startsWith('https://') && fileData.includes('appsheet.com')) {
                    console.log('Opening direct URL:', fileData);
                    window.open(fileData, '_blank');
                } else {
                    console.log('Creating URL for file:', fileData);
                    const baseUrl = 'https://www.appsheet.com/template/gettablefileurl';
                    const appName = 'QLVT-691992930';
                    const tableName = 'THONGBAO_KHAITHAC';

                    const fileUrl = `${baseUrl}?appName=${appName}&tableName=${tableName}&fileName=${encodeURIComponent(fileData)}`;

                    console.log('Generated URL:', fileUrl);
                    window.open(fileUrl, '_blank');
                }
            } catch (error) {
                console.error('L·ªói khi m·ªü file:', error);
                alert('Kh√¥ng th·ªÉ m·ªü file. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        }

        // Generate schedule table (unchanged from previous version)
        function generateScheduleTable(thongBaoList, chiTietList) {
            const bieuDoDiv = document.getElementById('bieuDoXeChay');

            if (!chiTietList || chiTietList.length === 0) {
                bieuDoDiv.innerHTML = `
                    <div class="text-center py-8 text-gray-500 italic">
                        Ch∆∞a c√≥ d·ªØ li·ªáu chi ti·∫øt xe ch·∫°y
                    </div>
                `;
                return;
            }

            const activeThongBaoIds = thongBaoList
                .filter(tb => !tb.TrangThai || tb.TrangThai !== 'H·∫øt hi·ªáu l·ª±c')
                .map(tb => tb.SoThongBao);

            const validChiTiet = chiTietList.filter(ct =>
                ct.SoThongBao && activeThongBaoIds.includes(ct.SoThongBao)
            );

            if (validChiTiet.length === 0) {
                bieuDoDiv.innerHTML = `
                    <div class="text-center py-8 text-gray-500 italic">
                        Ch∆∞a c√≥ d·ªØ li·ªáu chi ti·∫øt xe ch·∫°y cho c√°c th√¥ng b√°o c√≥ hi·ªáu l·ª±c
                    </div>
                `;
                return;
            }

            const groupedByThongBao = {};
            validChiTiet.forEach(ct => {
                const thongBaoId = ct.SoThongBao;
                if (!groupedByThongBao[thongBaoId]) {
                    groupedByThongBao[thongBaoId] = [];
                }
                groupedByThongBao[thongBaoId].push(ct);
            });

            const thongBaoKeys = Object.keys(groupedByThongBao);

            // Generate table for first half of month (1-15)
            let html = `
                <table class="w-full border-collapse text-xs bg-white">
                    <thead>
                        <tr>
                            <th rowspan="2" class="gradient-secondary text-white py-3 px-2 text-center border-2 border-gray-300 font-bold text-xs uppercase min-w-[60px]">STB</th>
            `;

            // Generate headers for days 1-15
            for (let day = 1; day <= 15; day++) {
                html += `
                    <th colspan="2" class="gradient-table py-3 px-2 text-center border-2 border-gray-300 font-bold text-gray-700 text-xs uppercase min-w-[80px]">
                        Ng√†y ${day}
                    </th>
                `;
            }

            html += `</tr><tr>`;

            // Generate sub-headers (ƒêi/V·ªÅ)
            for (let day = 1; day <= 15; day++) {
                html += `
                    <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">ƒêi</th>
                    <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">V·ªÅ</th>
                `;
            }

            html += `</tr></thead><tbody>`;

            // Generate rows for each th√¥ng b√°o
            thongBaoKeys.forEach((thongBaoId, index) => {
                const stbShort = thongBaoId.split('/')[0];
                html += `<tr><td class="gradient-secondary text-white py-2 px-1 text-center font-bold text-xs">${stbShort}</td>`;

                for (let day = 1; day <= 15; day++) {
                    const chiTietDi = groupedByThongBao[thongBaoId].filter(ct =>
                        ct.Chieu === 'ƒêi' &&
                        ct.NgayHoatDong && (
                            ct.NgayHoatDong.toString() === day.toString() ||
                            ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                            ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                        )
                    );

                    const chiTietVe = groupedByThongBao[thongBaoId].filter(ct =>
                        ct.Chieu === 'V·ªÅ' &&
                        ct.NgayHoatDong && (
                            ct.NgayHoatDong.toString() === day.toString() ||
                            ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                            ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                        )
                    );

                    html += `
                        <td class="text-center bg-amber-200 h-15 align-top pt-1">
                            ${chiTietDi.length > 0 ?
                                chiTietDi.map(ct =>
                                    `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                                ).join('') :
                                `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                            }
                        </td>
                        <td class="text-center bg-amber-200 h-15 align-top pt-1">
                            ${chiTietVe.length > 0 ?
                                chiTietVe.map(ct =>
                                    `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                                ).join('') :
                                `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                            }
                        </td>
                    `;
                }

                html += `</tr>`;
            });

            html += `</tbody></table>`;

            // Generate table for second half of month (16-31)
            html += `
                <div class="gradient-primary text-white text-center py-5 font-bold text-base uppercase tracking-wider">
                    Gi·ªù xu·∫•t b·∫øn
                </div>
                <table class="w-full border-collapse text-xs bg-white">
                    <thead>
                        <tr>
                            <th rowspan="2" class="gradient-secondary text-white py-3 px-2 text-center border-2 border-gray-300 font-bold text-xs uppercase min-w-[60px]">STB</th>
            `;

            // Generate headers for days 16-31
            for (let day = 16; day <= 31; day++) {
                html += `
                    <th colspan="2" class="gradient-table py-3 px-2 text-center border-2 border-gray-300 font-bold text-gray-700 text-xs uppercase min-w-[80px]">
                        Ng√†y ${day}
                    </th>
                `;
            }

            html += `</tr><tr>`;

            // Generate sub-headers (ƒêi/V·ªÅ)
            for (let day = 16; day <= 31; day++) {
                html += `
                    <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">ƒêi</th>
                    <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">V·ªÅ</th>
                `;
            }

            html += `</tr></thead><tbody>`;

            // Generate rows for each th√¥ng b√°o (16-31)
            thongBaoKeys.forEach((thongBaoId, index) => {
                const stbShort = thongBaoId.split('/')[0];
                html += `<tr><td class="gradient-secondary text-white py-2 px-1 text-center font-bold text-xs">${stbShort}</td>`;

                for (let day = 16; day <= 31; day++) {
                    const chiTietDi = groupedByThongBao[thongBaoId].filter(ct =>
                        ct.Chieu === 'ƒêi' &&
                        ct.NgayHoatDong && (
                            ct.NgayHoatDong.toString() === day.toString() ||
                            ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                            ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                        )
                    );

                    const chiTietVe = groupedByThongBao[thongBaoId].filter(ct =>
                        ct.Chieu === 'V·ªÅ' &&
                        ct.NgayHoatDong && (
                            ct.NgayHoatDong.toString() === day.toString() ||
                            ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                            ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                        )
                    );

                    html += `
                        <td class="text-center bg-amber-200 h-15 align-top pt-1">
                            ${chiTietDi.length > 0 ?
                                chiTietDi.map(ct =>
                                    `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                                ).join('') :
                                `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                            }
                        </td>
                        <td class="text-center bg-amber-200 h-15 align-top pt-1">
                            ${chiTietVe.length > 0 ?
                                chiTietVe.map(ct =>
                                    `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                                ).join('') :
                                `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                            }
                        </td>
                    `;
                }

                html += `</tr>`;
            });

            html += `</tbody></table>`;

            bieuDoDiv.innerHTML = html;
        }

        // Main initialization function
        async function initialize() {
            try {
                console.log('Starting initialization...');

                const startTime = performance.now();
                const { tuyenData, thongBaoData, chiTietData } = await loadAllDataParallel();
                const loadTime = performance.now() - startTime;
                console.log(`Data loaded in ${loadTime.toFixed(2)}ms`);

                updateProgress(70, 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...');

                // Store data globally
                allTuyenData = tuyenData;
                allThongBaoData = thongBaoData;
                allChiTietData = chiTietData;
                filteredTuyenData = tuyenData;

                console.log('Total routes:', allTuyenData.length);
                console.log('Total notifications:', allThongBaoData.length);
                console.log('Total details:', allChiTietData.length);

                updateProgress(80, 'ƒêang hi·ªÉn th·ªã danh s√°ch tuy·∫øn...');

                // Setup filter options
                setupFilterOptions();

                // Display route list
                displayRouteList(filteredTuyenData);

                updateProgress(90, 'Thi·∫øt l·∫≠p t√¨m ki·∫øm...');

                // Setup search functionality
                setupSearch();

                // Update current time
                document.getElementById('current-time-list').textContent = new Date().toLocaleString('vi-VN');

                updateProgress(100, 'T·∫£i th√†nh c√¥ng!');

                // Hide loading message and show route list
                setTimeout(() => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('routeListContent').style.display = 'block';
                }, 500);

                const totalTime = performance.now() - startTime;
                console.log(`Total processing time: ${totalTime.toFixed(2)}ms`);

            } catch (error) {
                console.error('Initialization failed:', error);
                document.getElementById('loadingMessage').innerHTML = `
                    <div class="text-center py-20">
                        <div class="text-red-600 text-lg font-bold mb-4">L·ªói t·∫£i d·ªØ li·ªáu</div>
                        <p class="text-gray-600">${error.message}</p>
                        <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Th·ª≠ l·∫°i
                        </button>
                    </div>
                `;
            }
        }

        // Utility functions
        function printDocument() {
            window.print();
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printDocument();
            }
            if (e.key === 'Escape') {
                // Press Escape to go back to list or close advanced search
                if (document.getElementById('routeDetailContent').style.display === 'block') {
                    backToList();
                } else if (document.getElementById('advancedSearchPanel').classList.contains('open')) {
                    toggleAdvancedSearch();
                }
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initialize);

        // Add some responsive behavior for search input
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('focus', function() {
                    this.style.borderColor = '#3b82f6';
                    this.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
                });
                
                searchInput.addEventListener('blur', function() {
                    this.style.borderColor = '#d1d5db';
                    this.style.boxShadow = 'none';
                });
            }
        });
    </script>

    <!-- Print styles -->
    <style>
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
            }

            #routeListContent,
            #routeDetailContent {
                box-shadow: none !important;
                border: none !important;
            }

            .no-print {
                display: none !important;
            }

            table {
                page-break-inside: auto;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            thead {
                display: table-header-group;
            }

            tfoot {
                display: table-footer-group;
            }
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            #routeListContent,
            #routeDetailContent {
                margin: 15px;
            }

            .grid-cols-6 {
                grid-template-columns: 1fr 2fr;
            }

            h1 {
                font-size: 1.5rem;
            }

            .grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .grid-cols-6 {
                grid-template-columns: 1fr;
            }

            .grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 10px;
            }

            .px-8 {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            /* Stack search elements vertically on mobile */
            .flex.items-center.gap-4 {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .flex-1 {
                width: 100%;
            }

            /* Hide some table columns on mobile */
            .mobile-hidden {
                display: none;
            }

            /* Make advanced search panel more mobile friendly */
            .filter-panel.open {
                max-height: 800px;
            }
        }

        /* Additional styling for better UX */
        .hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a90e2;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #357abd;
        }

        /* Table styling improvements */
        table {
            border-spacing: 0;
        }

        th, td {
            border: 1px solid #e5e7eb;
        }

        .route-row:nth-child(even) {
            background-color: #f9fafb;
        }

        .route-row:hover {
            background-color: #eff6ff !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Button hover effects */
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Loading animation improvements */
        .loading {
            margin: 0 auto;
        }

        /* Advanced search panel styling */
        #advancedSearchPanel {
            border-left: 4px solid #3b82f6;
        }

        #advancedSearchPanel.open {
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Filter tab active state */
        .filter-tab.active {
            background-color: #3b82f6;
            color: white;
        }

        /* Responsive table wrapper */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Status indicators */
        .status-active {
            color: #059669;
            font-weight: 600;
        }

        .status-inactive {
            color: #dc2626;
            font-weight: 600;
        }

        /* Tooltip styling */
        [title] {
            cursor: help;
        }
    </style>

    <!-- Mobile responsive meta tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Additional mobile styles for table -->
    <style>
        @media (max-width: 640px) {
            .overflow-x-auto {
                max-width: calc(100vw - 2rem);
            }
            
            table {
                min-width: 1200px; /* Ensure table doesn't get too cramped */
            }
            
            th, td {
                white-space: nowrap;
                min-width: 60px;
            }
            
            .px-4 {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .py-3 {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
        }
    </style>
</body>

</html>