<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω Th√¥ng tin Tuy·∫øn V·∫≠n t·∫£i - B·ªô Giao th√¥ng V·∫≠n t·∫£i</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1e3c72',
                        'primary-light': '#2a5298',
                        'secondary': '#4a90e2',
                        'secondary-light': '#357abd',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-primary {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .gradient-secondary {
            background: linear-gradient(135deg, #4a90e2, #357abd);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #ffffff, #f8fbff);
        }

        .gradient-light {
            background: linear-gradient(135deg, #f8fbff, #e8f4fd);
        }

        .gradient-table {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
        }

        .gradient-blue {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #f3f3f3;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            transition: width 0.3s ease;
        }
    </style>
</head>

<body class="font-sans min-h-screen leading-relaxed px-8">
    <div id="loadingMessage" class="text-center py-20">
        <div class="loading mb-4"></div>
        <p class="mb-4">ƒêang t·∫£i d·ªØ li·ªáu...</p>
        <div class="progress-bar mx-auto max-w-md mb-2">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div id="loadingText" class="text-sm text-gray-600">Kh·ªüi t·∫°o...</div>
    </div>

    <div id="mainContent"
        class="max-w-8xl mx-auto bg-white rounded-2xl overflow-hidden shadow-2xl border-2 border-blue-100"
        style="display: none;">
        <!-- Header ch√≠nh th·ª©c -->
        <div class="gradient-primary text-white py-6 px-8 text-center relative">
            <div class="flex items-center justify-center gap-5 mb-4">
                <div
                    class="w-15 h-15 bg-white rounded-full flex items-center justify-center text-2xl text-primary font-bold shadow-lg">
                    üöå
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-shadow">H·ªÜ TH·ªêNG QU·∫¢N L√ù TH√îNG TIN TUY·∫æN V·∫¨N T·∫¢I</h1>
                </div>
            </div>
        </div>

        <!-- Navigation header -->
        <div
            class="gradient-secondary text-white py-3 px-6 flex justify-between items-center border-b-4 border-blue-700">
            <h2 class="text-lg font-semibold flex items-center gap-3">
                <span class="text-xl">üìä</span>
                TH√îNG TIN TUY·∫æN
            </h2>
        </div>

        <!-- Th√¥ng tin chi ti·∫øt tuy·∫øn -->
        <div class="border-b-4 border-gray-100">
            <div class="gradient-light py-3 px-6 border-b-2 border-blue-200 flex items-center gap-4">
                <div class="text-secondary bg-white rounded-full shadow-md">üìã</div>
                <span class="font-bold text-gray-700 text-base uppercase tracking-wide">Th√¥ng tin chi ti·∫øt tuy·∫øn</span>
            </div>

            <div class="gradient-bg px-20 py-4" id="tuyenInfo">
                <!-- Th√¥ng tin tuy·∫øn s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn v√†o ƒë√¢y -->
            </div>
        </div>

        <!-- Th√¥ng tin th√¥ng b√°o ƒë∆°n v·ªã ƒëƒÉng k√Ω khai th√°c th√†nh c√¥ng -->
        <div class="border-b-4 border-gray-100">
            <div class="gradient-light py-3 px-6 border-b-2 border-blue-200 flex items-center gap-4">
                <div class="text-secondary bg-white rounded-full shadow-md">üìã</div>
                <span class="font-bold text-gray-700 text-base uppercase tracking-wide">Th√¥ng tin th√¥ng b√°o ƒë∆°n v·ªã ƒëƒÉng
                    k√Ω khai th√°c th√†nh c√¥ng</span>
            </div>

            <div class="gradient-bg p-4">
                <table class="w-full border-collapse border-2 border-gray-200 rounded-lg overflow-hidden shadow-lg">
                    <thead>
                        <tr>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                STT</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                S·ªë th√¥ng b√°o</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                Ng√†y vƒÉn b·∫£n th√¥ng b√°o</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                Ng√†y b·∫Øt ƒë·∫ßu khai th√°c</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                ƒê∆°n v·ªã kinh doanh v·∫≠n t·∫£i</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                C∆° quan c·∫•p</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="thongBaoTable">
                        <!-- D·ªØ li·ªáu th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn v√†o ƒë√¢y -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì xe ch·∫°y -->
        <div class="border-b-4 border-gray-100">
            <div class="gradient-light py-3 px-6 border-b-2 border-blue-200 flex items-center gap-4">
                <div class="text-secondary bg-white rounded-full shadow-md">üìã</div>
                <span class="font-bold text-gray-700 text-base uppercase tracking-wide">
                    Bi·ªÉu ƒë·ªì xe ch·∫°y
                    <span class="text-red-600 font-semibold">( Ch·ªâ c·∫≠p nh·∫≠t c√°c gi·ªù ƒëang c√≥ ƒë∆°n v·ªã KDVT khai th√°c
                        )</span>
                </span>
            </div>

            <!-- Legend -->
            <div class="flex gap-8 p-3 gradient-light text-xs justify-end flex-wrap border-b-2 border-gray-200">
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-gray-100 border-gray-200 shadow-sm"></div>
                    <span>Ch∆∞a ƒëƒÉng k√Ω</span>
                </div>
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-lime-300 border-white shadow-sm"></div>
                    <span>ƒêang khai th√°c</span>
                </div>
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-amber-300 border-white shadow-sm"></div>
                    <span>C√≤n l∆∞u l∆∞·ª£ng</span>
                </div>
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-amber-100 border-white shadow-sm"></div>
                    <span>H·∫øt l∆∞u l∆∞·ª£ng</span>
                </div>
            </div>

            <!-- L·ªãch xe ch·∫°y -->
            <div class="gradient-primary text-white text-center py-5 font-bold text-base uppercase tracking-wider">
                Gi·ªù xu·∫•t b·∫øn
            </div>

            <div id="bieuDoXeChay">
                <!-- Bi·ªÉu ƒë·ªì xe ch·∫°y s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
            </div>
        </div>

        <!-- Footer th√¥ng tin -->
        <div class="gradient-primary text-white py-5 text-center">
            <p class="mt-1 mb-0 text-xs opacity-70">
                C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="current-time"></span>
            </p>
        </div>
    </div>

    <script>
        // Constants for AppSheet connection
        const appId = 'd22767b5-f711-42f8-bbbd-4cf04b26ef3d';
        const accessKey = 'V2-Qcjpo-7Ybu9-g87XI-TFLes-kJGWn-btYR5-cLMmk-FjrRj';
        const region = 'www';

        // Progress tracking
        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('loadingText').textContent = text;
        }

        // Get MaSoTuyen from URL
        function getMaSoTuyenFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('MaSoTuyen');
        }

        // Function to fetch data from AppSheet - optimized
        async function fetchDataFromAppSheet(tableName) {
            try {
                const body = {
                    Action: 'Find',
                    Properties: {},
                    Selector: `Filter(${tableName}, true)`
                };

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error(`Failed to fetch data from ${tableName}:`, error);
                return [];
            }
        }

        // Load all data in parallel - FASTEST METHOD
        async function loadAllDataParallel() {
            updateProgress(10, 'ƒêang t·∫£i t·∫•t c·∫£ d·ªØ li·ªáu...');

            // Load t·∫•t c·∫£ b·∫£ng c√πng l√∫c (parallel)
            const [tuyenData, thongBaoData, bieuDoData, chiTietData] = await Promise.all([
                fetchDataFromAppSheet('DANHMUCTUYENCODINH'),
                fetchDataFromAppSheet('THONGBAO_KHAITHAC'),
                fetchDataFromAppSheet('BieuDoChayXe_Ghep'),
                fetchDataFromAppSheet('BieuDoChayXeChiTiet')
            ]);

            updateProgress(60, 'ƒê√£ t·∫£i xong d·ªØ li·ªáu, ƒëang x·ª≠ l√Ω...');

            return {
                tuyenData,
                thongBaoData,
                bieuDoData,
                chiTietData
            };
        }

        // Format date function
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        // Display route information
        function displayTuyenInfo(tuyenData) {
            const tuyenInfoDiv = document.getElementById('tuyenInfo');

            const infoHTML = `
                <div class="space-y-0">
                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            M√£ s·ªë tuy·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.MaSoTuyen || ''}</div>
                    </div>
                    
                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T√™n tuy·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TenTuyen || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T·ªânh n∆°i ƒëi:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TinhDi || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T·ªânh n∆°i ƒë·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TinhDen || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            BX ƒëi:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.BenDi || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            BX ƒë·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.BenDen || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex relative">
                            H√†nh tr√¨nh ch·∫°y xe:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex font-medium text-justify">
                            ${tuyenData.HanhTrinh || ''}
                        </div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            Ph√¢n lo·∫°i tuy·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.PhanLoaiTuyen || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T√¨nh tr·∫°ng khai th√°c tuy·∫øn:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TinhTrangKhaiThac || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            C·ª± ly Tuy·∫øn (km):
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.CuLyTuyen_km || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T·ªïng s·ªë chuy·∫øn xe ƒë∆∞·ª£c khai th√°c (chuy·∫øn/ th√°ng):
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TongChuyenThang || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            T·ªïng s·ªë chuy·∫øn xe ƒë√£ c√≥ ƒë∆°n v·ªã tham gia khai th√°c (chuy·∫øn/ th√°ng):
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.ChuyenDaKhaiThac || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            Th·ªùi gian gi√£n c√°ch t·ªëi thi·ªÉu gi·ªØa c√°c chuy·∫øn xe li√™n k·∫ø (ph√∫t/ chuy·∫øn):
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.GianCachToiThieu_phut || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            Quy·∫øt ƒë·ªãnh ban h√†nh:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.SoQuyetDinh || ''}</div>
                    </div>

                    <div class="grid grid-cols-6 border-gray-200">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            Ng√†y ban h√†nh:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.NgayBanHanh || ''}</div>
                    </div>

                    <div class="grid grid-cols-6">
                        <div class="col-span-2 text-sm font-bold flex items-center relative">
                            ƒê∆°n v·ªã ban h√†nh:
                            <div class="absolute right-0 w-1 gradient-secondary"></div>
                        </div>
                        <div class="col-span-4 text-sm text-gray-800 flex items-center font-medium">${tuyenData.DonViBanHanh || ''}</div>
                    </div>
                </div>
            `;

            tuyenInfoDiv.innerHTML = infoHTML;
        }

        // Display notification table - s·ª≠ d·ª•ng URL file tr·ª±c ti·∫øp t·ª´ AppSheet
        function displayThongBaoTable(thongBaoList) {
            const tableBody = document.getElementById('thongBaoTable');

            // L·ªçc ch·ªâ c√°c th√¥ng b√°o KH√îNG c√≥ tr·∫°ng th√°i "H·∫øt hi·ªáu l·ª±c"
            const activeThongBao = thongBaoList.filter(thongBao =>
                !thongBao.TrangThai || thongBao.TrangThai !== 'H·∫øt hi·ªáu l·ª±c'
            );

            if (!activeThongBao || activeThongBao.length === 0) {
                tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-8 text-gray-500 italic border border-gray-200">
                    Ch∆∞a c√≥ th√¥ng b√°o ƒëang c√≥ hi·ªáu l·ª±c
                </td>
            </tr>
        `;
                return;
            }

            let html = '';
            activeThongBao.forEach((thongBao, index) => {
                // Ki·ªÉm tra tr∆∞·ªùng File - AppSheet tr·∫£ v·ªÅ URL ƒë·∫ßy ƒë·ªß ho·∫∑c t√™n file
                const fileData = thongBao.File && thongBao.File.trim() !== '' ? thongBao.File.trim() : null;
                const hasFile = fileData && fileData !== '';

                // Log ƒë·ªÉ debug
                console.log(`Row ${index + 1}:`, {
                    SoThongBao: thongBao.SoThongBao,
                    File: fileData,
                    HasFile: hasFile
                });

                html += `
            <tr class="even:bg-blue-50">
                <td class="py-3 px-3 text-center border border-gray-200 text-xs">${index + 1}.</td>
                <td class="py-3 px-3 text-center border border-gray-200 text-xs">${thongBao.SoThongBao || ''}</td>
                <td class="py-3 px-3 text-center border border-gray-200 text-xs">${formatDate(thongBao.NgayBanHanh) || ''}</td>
                <td class="py-3 px-3 text-center border border-gray-200 text-xs">${thongBao.NgayBatDau || ''}</td>
                <td class="py-3 px-3 border border-gray-200 text-xs">${thongBao['ƒê∆°n v·ªã kinh doanh v·∫≠n t·∫£i'] || ''}</td>
                <td class="py-3 px-3 border border-gray-200 text-xs">${thongBao.CQBanHanh || ''}</td>
                <td class="py-4 px-3 text-center border border-gray-200">
                    <div class="flex justify-center gap-2">
                        ${hasFile ? `
                            <div class="w-8 h-8 gradient-blue text-white flex items-center justify-center rounded-lg cursor-pointer text-sm hover:opacity-80 transition-opacity" 
                                 title="M·ªü file ƒë√≠nh k√®m" 
                                 onclick="openAppSheetFile('${fileData.replace(/'/g, "\\'")}')">
                                üìÑ
                            </div>
                        ` : `
                            <div class="w-8 h-8 bg-gray-300 text-gray-500 flex items-center justify-center rounded-lg text-sm" 
                                 title="Kh√¥ng c√≥ file ƒë√≠nh k√®m">
                                üìÑ
                            </div>
                        `}
                    </div>
                </td>
            </tr>
        `;
            });

            tableBody.innerHTML = html;
        }

        // H√†m m·ªü file AppSheet - s·ª≠ d·ª•ng URL tr·ª±c ti·∫øp n·∫øu c√≥, ho·∫∑c t·∫°o URL
        function openAppSheetFile(fileData) {
            if (!fileData || fileData.trim() === '') {
                alert('Kh√¥ng c√≥ file ƒë√≠nh k√®m');
                return;
            }

            try {
                console.log('File data received:', fileData);

                // Ki·ªÉm tra n·∫øu fileData ƒë√£ l√† URL ƒë·∫ßy ƒë·ªß
                if (fileData.startsWith('https://www.appsheet.com/template/gettablefileurl') ||
                    fileData.startsWith('https://') && fileData.includes('appsheet.com')) {
                    // ƒê√£ l√† URL ƒë·∫ßy ƒë·ªß, m·ªü tr·ª±c ti·∫øp
                    console.log('Opening direct URL:', fileData);
                    window.open(fileData, '_blank');
                } else {
                    // L√† t√™n file, c·∫ßn t·∫°o URL
                    console.log('Creating URL for file:', fileData);
                    const baseUrl = 'https://www.appsheet.com/template/gettablefileurl';
                    const appName = 'QLVT-691992930';
                    const tableName = 'THONGBAO_KHAITHAC';

                    // T·∫°o URL m√† kh√¥ng c√≥ signature (AppSheet s·∫Ω t·ª± ƒë·ªông x·ª≠ l√Ω)
                    const fileUrl = `${baseUrl}?appName=${appName}&tableName=${tableName}&fileName=${encodeURIComponent(fileData)}`;

                    console.log('Generated URL:', fileUrl);
                    window.open(fileUrl, '_blank');
                }
            } catch (error) {
                console.error('L·ªói khi m·ªü file:', error);
                alert('Kh√¥ng th·ªÉ m·ªü file. Vui l√≤ng th·ª≠ l·∫°i sau.');
            }
        }

        function generateScheduleTable(bieuDoList, chiTietList) {
            const bieuDoDiv = document.getElementById('bieuDoXeChay');

            if (!bieuDoList || bieuDoList.length === 0) {
                bieuDoDiv.innerHTML = `
            <div class="text-center py-8 text-gray-500 italic">
                Ch∆∞a c√≥ d·ªØ li·ªáu bi·ªÉu ƒë·ªì xe ch·∫°y
            </div>
        `;
                return;
            }

            // L·ªçc ch·ªâ nh·ªØng bi·ªÉu ƒë·ªì th·ª±c s·ª± c√≥ chi ti·∫øt d·ªØ li·ªáu
            const validBieuDo = bieuDoList.filter(bieuDo => {
                return chiTietList.some(ct => ct.Ref_NutChayGhep === bieuDo.ID_Ghep);
            });

            if (validBieuDo.length === 0) {
                bieuDoDiv.innerHTML = `
            <div class="text-center py-8 text-gray-500 italic">
                Ch∆∞a c√≥ d·ªØ li·ªáu chi ti·∫øt xe ch·∫°y
            </div>
        `;
                return;
            }

            // Generate table for first half of month (1-15)
            let html = `
        <table class="w-full border-collapse text-xs bg-white">
            <thead>
                <tr>
                    <th rowspan="2" class="gradient-secondary text-white py-3 px-2 text-center border-2 border-gray-300 font-bold text-xs uppercase min-w-[60px]">STB</th>
    `;

            // Generate headers for days 1-15
            for (let day = 1; day <= 15; day++) {
                html += `
            <th colspan="2" class="gradient-table py-3 px-2 text-center border-2 border-gray-300 font-bold text-gray-700 text-xs uppercase min-w-[80px]">
                Ng√†y ${day}
            </th>
        `;
            }

            html += `</tr><tr>`;

            // Generate sub-headers (ƒêi/V·ªÅ)
            for (let day = 1; day <= 15; day++) {
                html += `
            <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">ƒêi</th>
            <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">V·ªÅ</th>
        `;
            }

            html += `</tr></thead><tbody>`;

            // Generate rows for each valid bi·ªÉu ƒë·ªì
            validBieuDo.forEach((bieuDo, index) => {
                html += `<tr><td class="gradient-secondary text-white py-2 px-1 text-center font-bold text-xs">${bieuDo['S·ªë th√¥ng b√°o']}</td>`;

                for (let day = 1; day <= 15; day++) {
                    // S·ª¨A: S·ª≠ d·ª•ng filter() thay v√¨ find() ƒë·ªÉ l·∫•y T·∫§T C·∫¢ chi ti·∫øt
                    const chiTietDi = chiTietList.filter(ct =>
                        ct.Ref_NutChayGhep === bieuDo.ID_Ghep &&
                        ct.Chieu === 'ƒêi' &&
                        ct.NgayHoatDong && (
                            ct.NgayHoatDong.toString() === day.toString() ||
                            ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                            ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                        )
                    );

                    const chiTietVe = chiTietList.filter(ct =>
                        ct.Ref_NutChayGhep === bieuDo.ID_Ghep &&
                        ct.Chieu === 'V·ªÅ' &&
                        ct.NgayHoatDong && (
                            ct.NgayHoatDong.toString() === day.toString() ||
                            ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                            ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                        )
                    );

                    html += `
                <td class="text-center bg-amber-200 h-15 align-top py-1">
                    ${chiTietDi.length > 0 ?
                            chiTietDi.map(ct =>
                                `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                            ).join('') :
                            `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                        }
                </td>
                <td class="text-center bg-amber-200 h-15 align-top py-1">
                    ${chiTietVe.length > 0 ?
                            chiTietVe.map(ct =>
                                `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                            ).join('') :
                            `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                        }
                </td>
            `;
                }

                html += `</tr>`;
            });

            html += `</tbody></table>`;

            // Generate table for second half of month (16-31) - t∆∞∆°ng t·ª±
            html += `
        <div class="gradient-primary text-white text-center py-5 font-bold text-base uppercase tracking-wider">
            Gi·ªù xu·∫•t b·∫øn
        </div>
        <table class="w-full border-collapse text-xs bg-white">
            <thead>
                <tr>
                    <th rowspan="2" class="gradient-secondary text-white py-3 px-2 text-center border-2 border-gray-300 font-bold text-xs uppercase min-w-[60px]">STB</th>
    `;

            // Generate headers for days 16-31
            for (let day = 16; day <= 31; day++) {
                html += `
            <th colspan="2" class="gradient-table py-3 px-2 text-center border-2 border-gray-300 font-bold text-gray-700 text-xs uppercase min-w-[80px]">
                Ng√†y ${day}
            </th>
        `;
            }

            html += `</tr><tr>`;

            // Generate sub-headers (ƒêi/V·ªÅ)
            for (let day = 16; day <= 31; day++) {
                html += `
           <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">ƒêi</th>
           <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">V·ªÅ</th>
       `;
            }

            html += `</tr></thead><tbody>`;

            // Generate rows for each valid bi·ªÉu ƒë·ªì (16-31)
            validBieuDo.forEach((bieuDo, index) => {
                html += `<tr><td class="gradient-secondary text-white py-2 px-1 text-center font-bold text-xs">${bieuDo['S·ªë th√¥ng b√°o']}</td>`;

                for (let day = 16; day <= 31; day++) {
                    // S·ª¨A: S·ª≠ d·ª•ng filter() cho ph·∫ßn th·ª© 2
                    const chiTietDi = chiTietList.filter(ct =>
                        ct.Ref_NutChayGhep === bieuDo.ID_Ghep &&
                        ct.Chieu === 'ƒêi' &&
                        ct.NgayHoatDong && (
                            ct.NgayHoatDong.toString() === day.toString() ||
                            ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                            ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                        )
                    );

                    const chiTietVe = chiTietList.filter(ct =>
                        ct.Ref_NutChayGhep === bieuDo.ID_Ghep &&
                        ct.Chieu === 'V·ªÅ' &&
                        ct.NgayHoatDong && (
                            ct.NgayHoatDong.toString() === day.toString() ||
                            ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                            ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                        )
                    );

                    html += `
               <td class="text-center bg-amber-200 h-15 align-top py-1">
                   ${chiTietDi.length > 0 ?
                            chiTietDi.map(ct =>
                                `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                            ).join('') :
                            `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                        }
               </td>
               <td class="text-center bg-amber-200 h-15 align-top py-1">
                   ${chiTietVe.length > 0 ?
                            chiTietVe.map(ct =>
                                `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                            ).join('') :
                            `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                        }
               </td>
           `;
                }

                html += `</tr>`;
            });

            html += `</tbody></table>`;

            bieuDoDiv.innerHTML = html;
        }

        // Main initialization function - OPTIMIZED FOR SPEED
        async function initialize() {
            try {
                const maSoTuyen = getMaSoTuyenFromURL();

                if (!maSoTuyen) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y m√£ s·ªë tuy·∫øn trong URL. Vui l√≤ng th√™m ?MaSoTuyen=XXX v√†o URL');
                }

                console.log('MaSoTuyen from URL:', maSoTuyen);

                // LOAD T·∫§T C·∫¢ D·ªÆ LI·ªÜU C√ôNG L√öC (PARALLEL) - NHANH NH·∫§T
                const startTime = performance.now();
                const { tuyenData, thongBaoData, bieuDoData, chiTietData } = await loadAllDataParallel();
                const loadTime = performance.now() - startTime;
                console.log(`Data loaded in ${loadTime.toFixed(2)}ms`);

                updateProgress(70, 'ƒêang l·ªçc d·ªØ li·ªáu...');

                // FILTER NHANH B·∫∞NG JAVASCRIPT
                const filteredTuyen = tuyenData.find(t => t.MaSoTuyen === maSoTuyen);
                if (!filteredTuyen) {
                    throw new Error(`Kh√¥ng t√¨m th·∫•y tuy·∫øn v·ªõi m√£ s·ªë: ${maSoTuyen}`);
                }

                // Filter th√¥ng b√°o
                const filteredThongBao = thongBaoData.filter(tb => tb.Ref_Tuyen === maSoTuyen);
                console.log('Filtered ThongBao:', filteredThongBao.length, 'records');

                // Filter bi·ªÉu ƒë·ªì
                const filteredBieuDo = bieuDoData.filter(bd => bd.Ref_Tuyen === maSoTuyen);
                console.log('Filtered BieuDo:', filteredBieuDo.length, 'records');

                // Filter chi ti·∫øt
                const ghepIds = filteredBieuDo.map(bd => bd.ID_Ghep);
                const filteredChiTiet = chiTietData.filter(ct => ghepIds.includes(ct.Ref_NutChayGhep));
                console.log('Filtered ChiTiet:', filteredChiTiet.length, 'records');

                updateProgress(80, 'ƒêang hi·ªÉn th·ªã d·ªØ li·ªáu...');

                // HI·ªÇN TH·ªä D·ªÆ LI·ªÜU
                displayTuyenInfo(filteredTuyen);
                displayThongBaoTable(filteredThongBao);
                generateScheduleTable(filteredBieuDo, filteredChiTiet);

                updateProgress(90, 'Ho√†n th√†nh...');

                // Update current time
                document.getElementById('current-time').textContent = new Date().toLocaleString('vi-VN');

                updateProgress(100, 'T·∫£i th√†nh c√¥ng!');

                // Hide loading message and show main content
                setTimeout(() => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                }, 500);

                const totalTime = performance.now() - startTime;
                console.log(`Total processing time: ${totalTime.toFixed(2)}ms`);

            } catch (error) {
                console.error('Initialization failed:', error);
                document.getElementById('loadingMessage').innerHTML = `
                   <div class="text-center py-20">
                       <div class="text-red-600 text-lg font-bold mb-4">L·ªói t·∫£i d·ªØ li·ªáu</div>
                       <p class="text-gray-600">${error.message}</p>
                       <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                           Th·ª≠ l·∫°i
                       </button>
                   </div>
               `;
            }
        }

        // Utility functions
        function printDocument() {
            window.print();
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printDocument();
            }
        });

        // Search function for different routes
        function searchRoute() {
            const maSoTuyen = prompt('Nh·∫≠p m√£ s·ªë tuy·∫øn c·∫ßn t√¨m:');
            if (maSoTuyen) {
                window.location.href = `${window.location.pathname}?MaSoTuyen=${encodeURIComponent(maSoTuyen)}`;
            }
        }

        // Add search button to header
        document.addEventListener('DOMContentLoaded', function () {
            const header = document.querySelector('.gradient-secondary');
            if (header) {
                const searchButton = document.createElement('button');
                searchButton.innerHTML = 'üîç T√¨m tuy·∫øn kh√°c';
                searchButton.className = 'bg-white text-secondary px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-colors';
                searchButton.onclick = searchRoute;
                header.appendChild(searchButton);
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initialize);

         document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script>

    <!-- Print styles -->
    <style>
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
            }

            #mainContent {
                box-shadow: none !important;
                border: none !important;
            }

            /* .gradient-primary,
            .gradient-secondary,
            .gradient-table {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            } */
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            #mainContent {
                margin: 15px;
            }

            .grid-cols-6 {
                grid-template-columns: 1fr 2fr;
            }

            h1 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .grid-cols-6 {
                grid-template-columns: 1fr;
            }

            .flex-wrap {
                gap: 15px;
            }

            table {
                font-size: 10px;
            }

            .px-8 {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        /* Additional styling for better UX */
        .hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a90e2;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #357abd;
        }
    </style>
</body>

</html>